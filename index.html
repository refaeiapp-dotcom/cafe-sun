<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>لوحة العميل</title>
  <style>
    body { font-family: Arial, sans-serif; direction: rtl; text-align: center; margin: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    th { background-color: #f2f2f2; }
    button { margin-top: 15px; padding: 10px 20px; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; }
    #submitOrder { background: #007bff; color: white; }
    #requestBill { background: #28a745; color: white; }
  </style>
</head>
<body>
  <h2>مرحباً بك في مقهى الشمس</h2>
  <p>اختر من القائمة:</p>

  <label>رقم الطاولة: <input type="number" id="tableNumber" min="1" max="50"></label>

  <table>
    <thead>
      <tr>
        <th>الصنف</th>
        <th>السعر</th>
        <th>الكمية</th>
        <th>الإجمالي</th>
      </tr>
    </thead>
    <tbody id="menu">
      <tr>
        <td>شاي</td><td>10</td>
        <td><select class="qty"><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option></select></td>
        <td class="total">0</td>
      </tr>
      <tr>
        <td>قهوة</td><td>15</td>
        <td><select class="qty"><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option></select></td>
        <td class="total">0</td>
      </tr>
      <tr>
        <td>عصير برتقال</td><td>20</td>
        <td><select class="qty"><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option></select></td>
        <td class="total">0</td>
      </tr>
    </tbody>
  </table>

  <p>ملاحظات: <br><textarea id="notes" rows="3" style="width:100%;"></textarea></p>
  <h3>المجموع الكلي: <span id="grandTotal">0</span> جنيه</h3>

  <button id="submitOrder">إتمام الطلب</button>
  <button id="requestBill">طلب الحساب</button>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getFirestore, collection, addDoc, query, where, orderBy, limit, getDocs, updateDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAYYtMci_1laKbOxpVYaHsMx670WPhtNbk",
      authDomain: "my-restaurant-aba99.firebaseapp.com",
      projectId: "my-restaurant-aba99",
      storageBucket: "my-restaurant-aba99.appspot.com",
      messagingSenderId: "512969391867",
      appId: "1:512969391867:web:36a528665b3469871a3a5e",
      measurementId: "G-XR5ZGKEZK8"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // تحديث المجموع
    document.querySelectorAll(".qty").forEach(select => {
      select.addEventListener("change", () => {
        const row = select.closest("tr");
        const price = parseInt(row.cells[1].textContent);
        const qty = parseInt(select.value);
        row.querySelector(".total").textContent = price * qty;

        let grand = 0;
        document.querySelectorAll(".total").forEach(cell => grand += parseInt(cell.textContent));
        document.getElementById("grandTotal").textContent = grand;
      });
    });

    // زرار إتمام الطلب
    document.getElementById("submitOrder").addEventListener("click", async () => {
      const tableNumber = document.getElementById("tableNumber").value;
      if (!tableNumber) { alert("⚠️ من فضلك أدخل رقم الطاولة"); return; }

      const order = [];
      document.querySelectorAll("#menu tr").forEach(row => {
        const item = row.cells[0].textContent;
        const price = parseInt(row.cells[1].textContent);
        const qty = parseInt(row.querySelector(".qty").value);
        if (qty > 0) order.push({ item, price, qty, total: price * qty });
      });

      if (order.length === 0) { alert("⚠️ اختر صنف واحد على الأقل"); return; }

      await addDoc(collection(db, "orders"), {
        table: tableNumber,
        order: order,
        notes: document.getElementById("notes").value,
        total: document.getElementById("grandTotal").textContent,
        status: "جديد",
        timestamp: new Date()
      });

      alert("✅ تم إرسال طلبك");
    });

    // زرار طلب الحساب
    document.getElementById("requestBill").addEventListener("click", async () => {
      const tableNumber = document.getElementById("tableNumber").value;
      if (!tableNumber) { alert("⚠️ من فضلك أدخل رقم الطاولة"); return; }

      const q = query(collection(db, "orders"), where("table", "==", tableNumber), orderBy("timestamp", "desc"), limit(1));
      const snapshot = await getDocs(q);
      if (!snapshot.empty) {
        const doc = snapshot.docs[0];
        await updateDoc(doc.ref, { status: "طلب حساب" });
        alert("✅ تم إرسال طلب الحساب للمدير");
      } else {
        alert("⚠️ لا يوجد طلبات لهذه الطاولة");
      }
    });
  </script>
</body>
</html>
