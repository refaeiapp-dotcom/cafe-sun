<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>لوحة العميل</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 10px; background: #f9f9f9; }
    h2 { text-align: center; }
    #tableNumber { text-align: center; font-size: 18px; margin-bottom: 10px; color: #333; font-weight: bold; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    th { background: #eee; }
    select, input[type="text"] { width: 100%; padding: 4px; }
    textarea { width: 100%; margin-top: 8px; padding: 6px; }
    button { margin: 5px 0; padding: 10px; width: 100%; font-size: 16px; border: none; border-radius: 5px; cursor: pointer; }
    #orderBtn { background: #4CAF50; color: white; }
    #billBtn { background: #2196F3; color: white; display: none; }
    #message { margin-top: 10px; text-align: center; font-weight: bold; }
  </style>
</head>
<body>
  <h2>قائمة الطعام</h2>
  <div id="tableNumber"></div> <!-- رقم الطاولة يظهر هنا -->

  <table>
    <thead>
      <tr>
        <th>الصنف</th>
        <th>السعر</th>
        <th>الكمية</th>
        <th>الإجمالي</th>
      </tr>
    </thead>
    <tbody id="menu"></tbody>
  </table>

  <h3>ملاحظات:</h3>
  <textarea id="notes" placeholder="اكتب ملاحظاتك هنا..."></textarea>

  <h3>الإجمالي الكلي: <span id="totalPrice">0</span> جنيه</h3>

  <button id="orderBtn">إتمام الطلب</button>
  <button id="billBtn">طلب الحساب</button>
  <div id="message"></div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
    import { getDatabase, ref, set, update } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAYYtMci_1laKbOxpVYaHsMx670WPhtNbk",
      authDomain: "my-restaurant-aba99.firebaseapp.com",
      projectId: "my-restaurant-aba99",
      storageBucket: "my-restaurant-aba99.appspot.com",
      messagingSenderId: "512969391867",
      appId: "1:512969391867:web:36a528665b3469871a3a5e",
      databaseURL: "https://my-restaurant-aba99-default-rtdb.firebaseio.com/"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const items = [
      { name: "شاي", price: 10 },
      { name: "قهوة", price: 15 },
      { name: "عصير برتقال", price: 20 },
      { name: "عصير مانجو", price: 25 },
      { name: "بيبسي", price: 12 },
      { name: "مياه معدنية", price: 8 },
      { name: "كيك", price: 30 },
      { name: "ساندوتش جبنة", price: 18 },
      { name: "بيتزا", price: 50 },
      { name: "برجر", price: 45 }
    ];

    const menu = document.getElementById("menu");
    const totalPriceEl = document.getElementById("totalPrice");

    items.forEach((item, index) => {
      const tr = document.createElement("tr");

      tr.innerHTML = `
        <td>${item.name}</td>
        <td>${item.price}</td>
        <td>
          <select id="qty-${index}">
            ${Array.from({length: 11}, (_,i) => `<option value="${i}">${i}</option>`).join("")}
          </select>
        </td>
        <td id="subtotal-${index}">0</td>
      `;
      menu.appendChild(tr);

      document.getElementById(`qty-${index}`).addEventListener("change", updateTotal);
    });

    function updateTotal() {
      let total = 0;
      items.forEach((item, index) => {
        const qty = parseInt(document.getElementById(`qty-${index}`).value);
        const subtotal = qty * item.price;
        document.getElementById(`subtotal-${index}`).textContent = subtotal;
        total += subtotal;
      });
      totalPriceEl.textContent = total;
    }

    // جلب رقم الطاولة من الرابط وعرضه
    const urlParams = new URLSearchParams(window.location.search);
    const tableNumber = urlParams.get("table") || "غير محدد";
    document.getElementById("tableNumber").textContent = "رقم الطاولة: " + tableNumber;

    // زرار إتمام الطلب
    document.getElementById("orderBtn").addEventListener("click", () => {
      const order = items.map((item, index) => {
        const qty = parseInt(document.getElementById(`qty-${index}`).value);
        return qty > 0 ? { name: item.name, price: item.price, qty } : null;
      }).filter(x => x);

      const notes = document.getElementById("notes").value;
      const total = totalPriceEl.textContent;

      if (order.length === 0) {
        document.getElementById("message").textContent = "الرجاء اختيار صنف واحد على الأقل";
        return;
      }

      set(ref(db, "orders/table" + tableNumber), {
        status: "قيد التنفيذ",
        color: "red",   // 🔴 لون أحمر عند إتمام الطلب
        table: tableNumber,
        order,
        notes,
        total
      });

      document.getElementById("message").textContent = "✅ طلبك قيد التنفيذ";
      document.getElementById("billBtn").style.display = "block";
    });

    // زرار طلب الحساب (تعديل فقط على الحالة واللون)
    document.getElementById("billBtn").addEventListener("click", () => {
      update(ref(db, "orders/table" + tableNumber), {
        status: "طلب حساب",
        color: "blue"   // 🔵 لون أزرق عند طلب الحساب
      });
      document.getElementById("message").textContent = "💳 تم إرسال طلب الحساب";
    });
  </script>
</body>
</html>
