<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>لوحة العميل</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 10px; direction: rtl; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #f4f4f4; }
    select { width: 60px; padding: 3px; }
    textarea { width: 100%; height: 60px; margin-top: 10px; }
    button { margin-top: 10px; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; }
    #confirmBtn { background: #16a34a; color: white; }
    #billBtn { background: #0ea5e9; color: white; display: none; }
    #status { margin-top: 15px; font-weight: bold; }
  </style>
</head>
<body>
  <h2>لوحة العميل - طاولة <span id="tableId"></span></h2>

  <table>
    <thead>
      <tr>
        <th>الصنف</th>
        <th>السعر</th>
        <th>الكمية</th>
      </tr>
    </thead>
    <tbody id="menu">
      <!-- يتم توليد الأصناف هنا -->
    </tbody>
  </table>

  <label for="notes">ملاحظات:</label>
  <textarea id="notes" placeholder="اكتب ملاحظاتك هنا"></textarea>

  <button id="confirmBtn">إتمام الطلب</button>
  <button id="billBtn">طلب الحساب</button>
  <div id="status"></div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

  <script>
    // إعداد Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAYYtMci_1laKbOxpVYaHsMx670WPhtNbk",
      authDomain: "my-restaurant-aba99.firebaseapp.com",
      projectId: "my-restaurant-aba99",
      storageBucket: "my-restaurant-aba99.appspot.com",
      messagingSenderId: "512969391867",
      appId: "1:512969391867:web:36a528665b3469871a3a5e"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // قائمة الأصناف
    const menuItems = [
      { name: "قهوة تركي", price: 20 },
      { name: "كابتشينو", price: 25 },
      { name: "شاي بالنعناع", price: 15 },
      { name: "عصير برتقال", price: 18 },
      { name: "بيبسي", price: 12 },
      { name: "مياه معدنية", price: 8 },
      { name: "ساندويتش جبنة", price: 30 },
      { name: "ساندويتش شاورما", price: 40 },
      { name: "بيتزا صغيرة", price: 50 },
      { name: "كرواسون", price: 22 }
    ];

    // تحديد رقم الطاولة من الرابط
    const urlParams = new URLSearchParams(window.location.search);
    const tableId = urlParams.get("table") || "غير محدد";
    document.getElementById("tableId").textContent = tableId;

    // توليد القائمة
    const menuTable = document.getElementById("menu");
    menuItems.forEach((item, i) => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${item.name}</td>
        <td>${item.price} ج</td>
        <td>
          <select id="qty-${i}">
            ${Array.from({length: 11}, (_, n) => `<option value="${n}">${n}</option>`).join("")}
          </select>
        </td>
      `;
      menuTable.appendChild(row);
    });

    let lastOrderDocId = null;

    // إتمام الطلب
    document.getElementById("confirmBtn").addEventListener("click", async () => {
      const order = menuItems.map((item, i) => {
        const qty = parseInt(document.getElementById(`qty-${i}`).value);
        return qty > 0 ? { ...item, quantity: qty } : null;
      }).filter(x => x);

      const notes = document.getElementById("notes").value;
      if(order.length === 0 && !notes){
        document.getElementById("status").style.color = "red";
        document.getElementById("status").textContent = "⚠️ اختر صنف أو اكتب ملاحظة.";
        return;
      }

      try {
        const docRef = await db.collection("orders").add({
          table: tableId,
          order,
          notes,
          status: "طلب جديد",
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        lastOrderDocId = docRef.id;
        document.getElementById("status").style.color = "green";
        document.getElementById("status").textContent = "✅ تم إرسال الطلب.";
        document.getElementById("billBtn").style.display = "inline-block";
      } catch(err) {
        console.error(err);
        document.getElementById("status").style.color = "red";
        document.getElementById("status").textContent = "تعذر إرسال الطلب.";
      }
    });

    // طلب الحساب
    document.getElementById("billBtn").addEventListener("click", async () => {
      if(!lastOrderDocId){
        document.getElementById("status").style.color = "red";
        document.getElementById("status").textContent = "⚠️ لم يتم تسجيل طلب.";
        return;
      }
      try {
        await db.collection("orders").doc(lastOrderDocId).update({
          status: "طلب حساب",
          billRequestedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        document.getElementById("status").style.color = "#0ea5e9";
        document.getElementById("status").textContent = "✅ تم إرسال طلب الحساب.";
        document.getElementById("billBtn").disabled = true;
        document.getElementById("billBtn").style.opacity = "0.6";
      } catch(err) {
        console.error(err);
        document.getElementById("status").style.color = "red";
        document.getElementById("status").textContent = "تعذر إرسال طلب الحساب.";
      }
    });
  </script>
</body>
</html>
