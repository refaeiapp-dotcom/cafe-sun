<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 10px; background: #f9f9f9; }
    h2 { text-align: center; }
    #tableNumber { text-align: center; font-size: 18px; margin-bottom: 10px; color: #333; font-weight: bold; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    th { background: #eee; }
    select, input[type="text"] { width: 100%; padding: 4px; }
    textarea { width: 100%; margin-top: 8px; padding: 6px; }
    button { margin: 5px 0; padding: 10px; width: 100%; font-size: 16px; border: none; border-radius: 5px; cursor: pointer; }
    #orderBtn { background: #4CAF50; color: white; }
    #billBtn { background: #2196F3; color: white; display: none; }
    #message { margin-top: 10px; text-align: center; font-weight: bold; }

    /* Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø£Ø³ÙÙ„ Ø§Ù„ØµÙØ­Ø© (Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·) */
    .orders-section { margin-top: 18px; }
    .orders-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
    .orders-list { display: grid; gap: 10px; }
    .order-card { background:#fff; border:1px solid #e5e5e5; border-radius:8px; padding:10px; }
    .order-top { display:flex; justify-content:space-between; align-items:center; margin-bottom:6px; }
    .badge { padding:2px 8px; border-radius:12px; font-size:12px; }
    .badge.red { background:#ffe1e1; color:#c62828; }
    .badge.yellow { background:#fff4ce; color:#8a6d00; }
    .badge.blue { background:#d9ecff; color:#0d47a1; }
    .badge.green { background:#dbf5e1; color:#1b5e20; }
    .order-items { margin:0; padding-right:18px; }
    .order-total { font-weight:bold; margin-top:6px; }
    .running-total { margin-top:10px; font-size:16px; font-weight:bold; text-align:center; }
  </style>
</head>
<body>
  <h2>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ø¹Ø§Ù…</h2>
  <div id="tableNumber"></div>

  <table>
    <thead>
      <tr>
        <th>Ø§Ù„ØµÙ†Ù</th>
        <th>Ø§Ù„Ø³Ø¹Ø±</th>
        <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
        <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
      </tr>
    </thead>
    <tbody id="menu"></tbody>
  </table>

  <h3>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</h3>
  <textarea id="notes" placeholder="Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒ Ù‡Ù†Ø§..."></textarea>

  <h3>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ: <span id="totalPrice">0</span> Ø¬Ù†ÙŠÙ‡</h3>

  <button id="orderBtn">Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨</button>
  <button id="billBtn">Ø·Ù„Ø¨ Ø§Ù„Ø­Ø³Ø§Ø¨</button>
  <div id="message"></div>

  <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø­ÙŠØ© (Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·) -->
  <div class="orders-section">
    <div class="orders-header">
      <h3 style="margin:0">Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø·Ø§ÙˆÙ„Ø©</h3>
      <small>ØªØªØ­Ø¯Ø« ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§</small>
    </div>
    <div id="ordersList" class="orders-list"></div>
    <div class="running-total">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†: <span id="runningTotal">0</span> Ø¬Ù†ÙŠÙ‡</div>
  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
    import { getDatabase, ref, push, update, onValue } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAYYtMci_1laKbOxpVYaHsMx670WPhtNbk",
      authDomain: "my-restaurant-aba99.firebaseapp.com",
      projectId: "my-restaurant-aba99",
      storageBucket: "my-restaurant-aba99.appspot.com",
      messagingSenderId: "512969391867",
      appId: "1:512969391867:web:36a528665b3469871a3a5e",
      databaseURL: "https://my-restaurant-aba99-default-rtdb.firebaseio.com/"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    const items = [
      { name: "Ø´Ø§ÙŠ", price: 10 },
      { name: "Ù‚Ù‡ÙˆØ©", price: 15 },
      { name: "Ø¹ØµÙŠØ± Ø¨Ø±ØªÙ‚Ø§Ù„", price: 20 },
      { name: "Ø¹ØµÙŠØ± Ù…Ø§Ù†Ø¬Ùˆ", price: 25 },
      { name: "Ø¨ÙŠØ¨Ø³ÙŠ", price: 12 },
      { name: "Ù…ÙŠØ§Ù‡ Ù…Ø¹Ø¯Ù†ÙŠØ©", price: 8 },
      { name: "ÙƒÙŠÙƒ", price: 30 },
      { name: "Ø³Ø§Ù†Ø¯ÙˆØªØ´ Ø¬Ø¨Ù†Ø©", price: 18 },
      { name: "Ø¨ÙŠØªØ²Ø§", price: 50 },
      { name: "Ø¨Ø±Ø¬Ø±", price: 45 }
    ];

    const menu = document.getElementById("menu");
    const totalPriceEl = document.getElementById("totalPrice");

    items.forEach((item, index) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${item.name}</td>
        <td>${item.price}</td>
        <td>
          <select id="qty-${index}">
            ${Array.from({length: 11}, (_,i) => `<option value="${i}">${i}</option>`).join("")}
          </select>
        </td>
        <td id="subtotal-${index}">0</td>
      `;
      menu.appendChild(tr);
      document.getElementById(`qty-${index}`).addEventListener("change", updateTotal);
    });

    function updateTotal() {
      let total = 0;
      items.forEach((item, index) => {
        const qty = parseInt(document.getElementById(`qty-${index}`).value) || 0;
        const subtotal = qty * item.price;
        document.getElementById(`subtotal-${index}`).textContent = subtotal;
        total += subtotal;
      });
      totalPriceEl.textContent = total;
    }

    // Ø±Ù‚Ù… Ø§Ù„Ø·Ø§ÙˆÙ„Ø© Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·
    const urlParams = new URLSearchParams(window.location.search);
    const tableNumber = urlParams.get("table") || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
    document.getElementById("tableNumber").textContent = "Ø±Ù‚Ù… Ø§Ù„Ø·Ø§ÙˆÙ„Ø©: " + tableNumber;

    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ â€”> ÙŠØ³ØªØ®Ø¯Ù… push (Ø¥Ø¶Ø§ÙØ© Ø¯ÙˆÙ† Ø­Ø°Ù Ø§Ù„Ù‚Ø¯ÙŠÙ…)
    document.getElementById("orderBtn").addEventListener("click", () => {
      const order = items.map((item, index) => {
        const qty = parseInt(document.getElementById(`qty-${index}`).value) || 0;
        return qty > 0 ? { name: item.name, price: item.price, qty } : null;
      }).filter(Boolean);

      const notes = document.getElementById("notes").value;
      const total = Number(totalPriceEl.textContent || 0);

      if (order.length === 0) {
        document.getElementById("message").textContent = "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± ØµÙ†Ù ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„";
        return;
      }

      const ordersRef = ref(db, "orders/table" + tableNumber);
      const newRef = push(ordersRef, {
        status: "Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°",
        color: "red",
        table: tableNumber,
        order,
        notes,
        total,
        time: new Date().toLocaleString()
      });

      // Ø­ÙØ¸ Ù…ÙØªØ§Ø­ Ø¢Ø®Ø± Ø·Ù„Ø¨ Ù„Ø²Ø± Ø§Ù„Ø­Ø³Ø§Ø¨
      localStorage.setItem("lastOrderKey", newRef.key);

      document.getElementById("message").textContent = "âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨";
      document.getElementById("billBtn").style.display = "block";
    });

    // Ø·Ù„Ø¨ Ø§Ù„Ø­Ø³Ø§Ø¨ â€”> ÙŠØ­Ø¯Ù‘Ø« Ø¢Ø®Ø± Ø·Ù„Ø¨ ÙÙ‚Ø·
    document.getElementById("billBtn").addEventListener("click", () => {
      const lastKey = localStorage.getItem("lastOrderKey");
      if (!lastKey) {
        document.getElementById("message").textContent = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨ Ø­Ø¯ÙŠØ« Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø­Ø³Ø§Ø¨.";
        return;
      }
      const orderRef = ref(db, `orders/table${tableNumber}/${lastKey}`);
      update(orderRef, { status: "Ø·Ù„Ø¨ Ø­Ø³Ø§Ø¨", color: "blue" });
      document.getElementById("message").textContent = "ğŸ’³ ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø­Ø³Ø§Ø¨";
    });

    // ====== Ø¹Ø±Ø¶ Ø­ÙŠÙ‘ Ù„Ø·Ù„Ø¨Ø§Øª Ù†ÙØ³ Ø§Ù„Ø·Ø§ÙˆÙ„Ø© (Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·) ======
    const ordersList = document.getElementById("ordersList");
    const runningTotalEl = document.getElementById("runningTotal");
    const tableRef = ref(db, "orders/table" + tableNumber);

    // Ø¨Ø¹Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù‚Ø¯ ØªÙƒÙˆÙ† Ù…Ø­ÙÙˆØ¸Ø© Ø¨ØµÙŠØºØ© "Ø·Ù„Ø¨ ÙˆØ§Ø­Ø¯" (Ù‚Ø¨Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„).
    function toNumber(x){ return typeof x === "number" ? x : parseFloat(x) || 0; }
    function statusClass(s){
      switch(s){
        case "Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°": return "red";
        case "Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ø¶ÙŠØ±": return "yellow";
        case "Ø·Ù„Ø¨ Ø­Ø³Ø§Ø¨": return "blue";
        case "Ù…Ù†ØªÙ‡ÙŠ": return "green";
        default: return "yellow";
      }
    }

    function escapeHTML(str){
      return String(str).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    onValue(tableRef, (snapshot) => {
      ordersList.innerHTML = "";
      let grandTotal = 0;

      if (!snapshot.exists()) {
        ordersList.innerHTML = "<div class='order-card'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¨Ø¹Ø¯.</div>";
        runningTotalEl.textContent = "0";
        return;
      }

      const rootVal = snapshot.val();

      // ØªÙ†Ø³ÙŠÙ‚ Ù‚Ø¯ÙŠÙ… (Ø·Ù„Ø¨ ÙˆØ§Ø­Ø¯ Ù…Ø¨Ø§Ø´Ø±Ø©Ù‹ ØªØ­Øª tableX)
      if (rootVal && Array.isArray(rootVal.order)) {
        renderOrderCard(rootVal);
        grandTotal += toNumber(rootVal.total);
      } else {
        // Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (push Ù„ÙƒÙ„ Ø·Ù„Ø¨)
        snapshot.forEach(child => {
          const data = child.val();
          renderOrderCard(data);
          grandTotal += toNumber(data.total);
        });
      }

      runningTotalEl.textContent = grandTotal;
    });

    function renderOrderCard(data){
      const card = document.createElement("div");
      card.className = "order-card";

      let itemsHtml = "<ul class='order-items'>";
      if (Array.isArray(data.order)) {
        data.order.forEach(it => {
          const line = `${it.name} Ã— ${it.qty} (${it.price}Ø¬) = ${toNumber(it.qty) * toNumber(it.price)}Ø¬`;
          itemsHtml += `<li>${line}</li>`;
        });
      }
      itemsHtml += "</ul>";

      card.innerHTML = `
        <div class="order-top">
          <div>${data.time ? escapeHTML(data.time) : ""}</div>
          <div class="badge ${statusClass(data.status)}">${data.status || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"}</div>
        </div>
        ${itemsHtml}
        ${data.notes ? `<div class="order-notes"><b>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</b> ${escapeHTML(data.notes)}</div>` : ""}
        <div class="order-total"><b>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</b> ${toNumber(data.total)} Ø¬Ù†ÙŠÙ‡</div>
      `;
      ordersList.appendChild(card);
    }
  </script>
</body>
</html>
