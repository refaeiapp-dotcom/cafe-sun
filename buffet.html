<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>لوحة البوفيه</title>
  <style>
    body { font-family: Tahoma, Arial, sans-serif; background: #f4f4f4; padding: 20px; }
    h1 { text-align: center; color: darkblue; }
    .order-box {
      background: white; padding: 15px; margin: 10px auto;
      border-radius: 8px; border: 1px solid #ccc; max-width: 500px;
      text-align: right;
    }
    .order-box h3 { margin: 0 0 10px; color: darkred; }
    .order-box ul { margin: 0; padding-right: 20px; }
    button {
      margin-top: 10px; padding: 8px 16px; border: none; border-radius: 5px;
      cursor: pointer; font-weight: bold; color: white;
    }
    .done-btn { background: green; }
  </style>
</head>
<body>
  <h1>🍽️ لوحة البوفيه</h1>
  <div id="orders"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
    import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAYYtMci_1laKbOxpVYaHsMx670WPhtNbk",
      authDomain: "my-restaurant-aba99.firebaseapp.com",
      projectId: "my-restaurant-aba99",
      storageBucket: "my-restaurant-aba99.appspot.com",
      messagingSenderId: "512969391867",
      appId: "1:512969391867:web:36a528665b3469871a3a5e",
      databaseURL: "https://my-restaurant-aba99-default-rtdb.firebaseio.com/"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const ordersDiv = document.getElementById("orders");

    // 🔹 راقب جميع الطلبات المرسلة للبوفيه
    const buffetRef = ref(db, "buffet");
    onValue(buffetRef, (snapshot) => {
      ordersDiv.innerHTML = "";
      if (snapshot.exists()) {
        snapshot.forEach(tableSnap => {
          const tableNumber = tableSnap.key.replace("table", "");
          tableSnap.forEach(orderSnap => {
            const orderId = orderSnap.key;
            const data = orderSnap.val();

            let html = `<div class="order-box">`;
            html += `<h3>طاولة ${tableNumber} - الحالة: ${data.status || ""}</h3>`;
            if (data.order) {
              html += "<ul>";
              data.order.forEach(item => {
                html += `<li>${item.name} × ${item.qty} = ${item.qty * item.price}ج</li>`;
              });
              html += "</ul>";
            }
            html += `<p><b>الإجمالي:</b> ${data.total} جنيه</p>`;
            if (data.notes) html += `<p><b>ملاحظات:</b> ${data.notes}</p>`;
            html += `<button class="done-btn" onclick="markAsDone('${tableNumber}','${orderId}')">✅ تم التجهيز</button>`;
            html += `</div>`;
            ordersDiv.innerHTML += html;
          });
        });
      } else {
        ordersDiv.innerHTML = "<p>لا توجد طلبات حالياً</p>";
      }
    });

    // 🔹 تحديث الحالة عند الانتهاء
    window.markAsDone = function(tableNumber, orderId) {
      set(ref(db, `buffet/table${tableNumber}/${orderId}/status`), "منتهي");
      set(ref(db, `orders/table${tableNumber}/${orderId}/status`), "منتهي");
    }
  </script>
</body>
</html>
