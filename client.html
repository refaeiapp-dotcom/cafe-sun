<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Ø·Ù„Ø¨ ÙƒØ´Ø±ÙŠ â€“ Ø·Ø§ÙˆÙ„Ø©</title>
<style>
body{
    font-family:Arial;
    direction:rtl;
    background:#f2f2f2;
    padding:20px;
}
h1{text-align:center;}
.item{
    background:#fff;
    padding:10px;
    margin-bottom:8px;
    border-radius:6px;
    display:flex;
    justify-content:space-between;
    align-items:center;
}
select{padding:5px;}
.total{
    background:#fff;
    padding:15px;
    margin-top:15px;
    border-radius:6px;
    text-align:center;
    font-size:18px;
    font-weight:bold;
}
button{
    width:100%;
    padding:15px;
    margin-top:10px;
    font-size:17px;
    border:none;
    border-radius:6px;
    color:#fff;
    cursor:pointer;
}
.pending{background:#dc3545;} /* Ø£Ø­Ù…Ø± */
.accepted{background:#28a745;} /* Ø£Ø®Ø¶Ø± */
.yellow{background:#ffc107;} /* Ø£ØµÙØ± */
.status-text{
    font-size:14px;
    text-align:center;
    margin-bottom:5px;
    color:#444;
}
</style>
</head>
<body>

<h1 id="tableTitle">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª â€“ Ø·Ø§ÙˆÙ„Ø© Ø±Ù‚Ù…</h1>

<!-- Ø§Ù„Ø£ØµÙ†Ø§Ù -->
<div class="item"><span>Ø¹Ù„Ø¨Ø© ÙƒØ´Ø±ÙŠ Ø¨ÙŠØ¬ Ø³ØªØ§Ø± (45)</span>
<select data-price="45"><option>0</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option></select></div>
<div class="item"><span>Ø¹Ù„Ø¨Ø© ÙƒØ´Ø±ÙŠ ØµØºÙŠØ±Ø© (23)</span>
<select data-price="23"><option>0</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option></select></div>
<div class="item"><span>Ø·Ø§Ø¬Ù† Ù…ÙƒØ±ÙˆÙ†Ø© Ø¨Ø§Ù„ÙØ±Ø§Ø® (55)</span>
<select data-price="55"><option>0</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option></select></div>
<div class="item"><span>Ø¹Ù„Ø¨Ø© ÙƒØ´Ø±ÙŠ Ø³ÙˆØ¨Ø± Ø³ØªØ§Ø± (55)</span>
<select data-price="55"><option>0</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option></select></div>
<div class="item"><span>ØªÙˆØ³Øª ÙƒØ±Ø³Ø¨ÙŠ (10)</span>
<select data-price="10"><option>0</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option></select></div>
<div class="item"><span>Ø·Ø§Ø¬Ù† Ù…ÙƒØ±ÙˆÙ†Ø© Ø¨Ø§Ù„Ù„Ø­Ù…Ø© (50)</span>
<select data-price="50"><option>0</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option></select></div>
<div class="item"><span>Ø¹Ù„Ø¨Ø© ÙƒØ´Ø±ÙŠ Ø³ØªØ§Ø± Ø¨Ù„Ø³ (38)</span>
<select data-price="38"><option>0</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option></select></div>
<div class="item"><span>Ø£Ø±Ø² Ø¨Ø§Ù„Ù„Ø¨Ù† ØµØºÙŠØ± (20)</span>
<select data-price="20"><option>0</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option></select></div>
<div class="item"><span>Ø³Ù„Ø·Ø© Ø®Ø¶Ø±Ø§Ø¡ (12)</span>
<select data-price="12"><option>0</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option></select></div>
<div class="item"><span>ÙƒØ±ÙŠÙ… ÙƒØ±Ø§Ù…ÙŠÙ„ (22)</span>
<select data-price="22"><option>0</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option></select></div>

<div class="total">
ğŸ’° Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: <span id="total">0</span> Ø¬Ù†ÙŠÙ‡
</div>

<div class="status-text" id="orderStatus"></div>
<button id="orderBtn" class="pending">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>

<div class="status-text" id="billStatus"></div>
<button id="billBtn" class="pending">Ø·Ù„Ø¨ Ø§Ù„Ø­Ø³Ø§Ø¨</button>

<div class="status-text" id="callStatus"></div>
<button id="callBtn" class="pending">Ù†Ø¯Ø§Ø¡ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (Ø·ÙˆØ§Ø±Ø¦)</button>

<div class="status-text">ğŸ“¤ ÙŠØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… (Ø§Ù„Ù…Ø¯ÙŠØ±)</div>

<!-- Firebase SDK -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, push, set, onValue, update } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCXk63HWqwQMaNAOrb5HgVRaRgF998I3jo",
  authDomain: "kosharyapp.firebaseapp.com",
  databaseURL: "https://kosharyapp-default-rtdb.firebaseio.com",
  projectId: "kosharyapp",
  storageBucket: "kosharyapp.firebasestorage.app",
  messagingSenderId: "129714098738",
  appId: "1:129714098738:web:aa5c0aab07191dfa2be22b",
  measurementId: "G-G8SDKEN0RW"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const urlParams = new URLSearchParams(window.location.search);
const tableNum = urlParams.get("table") || 1;
document.getElementById("tableTitle").innerText = `Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª â€“ Ø·Ø§ÙˆÙ„Ø© Ø±Ù‚Ù… ${tableNum}`;

window.onload = function(){
    const selects = document.querySelectorAll("select");
    const totalSpan = document.getElementById("total");

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹
    selects.forEach(s=>{
        s.onchange = ()=>{
            let total=0;
            selects.forEach(el=>{
                total += el.dataset.price * el.value;
            });
            totalSpan.innerText = total;
        };
    });

    function waitManager(btn,statusDiv){
        btn.classList.add("pending");
        btn.classList.remove("accepted","yellow");
        document.getElementById(statusDiv).innerText = "â³ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ù…Ø¯ÙŠØ±...";
    }

    function updateButtonStatus(btn,statusDiv,status){
        btn.classList.remove("pending","accepted","yellow");
        if(status==="pending") btn.classList.add("pending");
        else if(status==="accepted") btn.classList.add("accepted");
        else if(status==="inProgress") btn.classList.add("yellow");

        let textMap = {
            pending:"â³ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ù…Ø¯ÙŠØ±...",
            accepted:"âœ”ï¸ ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨",
            inProgress:"ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¶ÙŠØ±"
        };
        document.getElementById(statusDiv).innerText = textMap[status] || "";
    }

    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨
    document.getElementById("orderBtn").onclick = function(){
        waitManager(this,"orderStatus");
        const items = [];
        selects.forEach(el=>{
            if(el.value>0){
                items.push({
                    name: el.parentElement.querySelector("span").innerText.split(" (")[0],
                    qty: parseInt(el.value),
                    price: parseInt(el.dataset.price)
                });
            }
        });
        if(items.length===0){alert("Ø§Ø®ØªØ± Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ ØµÙ†Ù ÙˆØ§Ø­Ø¯"); return;}

        const orderRef = push(ref(db, "pendingOrders"));

        set(orderRef,{
            tableNum: tableNum,
            workerNum: null,
            items: items,
            totalPrice: items.reduce((a,b)=>a+b.price*b.qty,0),
            status: "pending"
        }).then(()=> updateButtonStatus(document.getElementById("orderBtn"),"orderStatus","pending"))
          .catch(err=>{console.error(err); alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„");});
    };

    // Ø·Ù„Ø¨ Ø§Ù„Ø­Ø³Ø§Ø¨
    document.getElementById("billBtn").onclick = function(){
        waitManager(this,"billStatus");
        const billRef = push(ref(db, "bills"));
        set(billRef,{
            tableNum: tableNum,
            status:"pending"
        });

        const ordersRef = ref(db, "pendingOrders")
;
        onValue(ordersRef, snapshot=>{
            const data = snapshot.val() || {};
            Object.keys(data).forEach(key=>{
                if(data[key].tableNum == tableNum){
                    update(ref(db,"orders/"+key), { status:"bill" });
                }
            });
        }, {onlyOnce:true});
    };

    // Ù†Ø¯Ø§Ø¡ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
    document.getElementById("callBtn").onclick = function(){
        waitManager(this,"callStatus");
        const callRef = push(ref(db, "calls"));
        set(callRef,{
            tableNum:tableNum,
            status:"pending"
        });
    };

    // ======== Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù„Ø¨Ø§Øª ========
    const ordersRef = ref(db, "orders");
    onValue(ordersRef, snapshot=>{
        snapshot.forEach(child=>{
            const order = child.val();
            if(order.tableNum==tableNum){
                const orderBtn = document.getElementById("orderBtn");

                // Ø¥Ø°Ø§ Ø§Ù„Ø­Ø§Ù„Ø© bill (Ø£Ø²Ø±Ù‚)ØŒ Ù†Ø¹ÙŠØ¯ Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø­Ù…Ø± Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙÙ‚Ø·
                if(order.status === "bill"){
                    orderBtn.classList.remove("accepted","yellow","pending");
                    orderBtn.classList.add("pending"); // Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø­Ù…Ø±
                    document.getElementById("orderStatus").innerText = "â³ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ù…Ø¯ÙŠØ±...";
                } else {
                    updateButtonStatus(orderBtn,"orderStatus",order.status);
                }
            }
        });
    });

};
</script>
</body>
</html>
