<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ù„ÙˆØ­Ø© Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø¹Ù…Ø§Ù„ (Ø«Ø§Ø¨ØªØ© Ù…Ø¹ Ø£Ø±Ø´ÙØ©)</title>
  <style>
    body { font-family: Tahoma, Arial, sans-serif; margin: 0; padding: 20px; background: #f7fafc; color: #222; }
    h1 { text-align: center; margin: 0 0 10px; }
    .hint { text-align:center; margin: 0 0 20px; color:#555; font-size:14px; }

    .wrap { display: grid; grid-template-columns: 1fr; gap: 18px; max-width: 1280px; margin: 0 auto; }

    .panel { background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; padding: 14px; box-shadow: 0 1px 3px rgba(0,0,0,.05); }
    .panel h2 { margin: 0 0 10px; font-size: 18px; color:#1f2937; }

    .grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; }
    .barista { background: #ffffff; border: 1px solid #e5e7eb; border-radius: 12px; padding: 10px; }
    .barista h3 { margin: 0 0 8px; font-size: 16px; color:#0b3b60; }

    .order { background: #f3f4f6; border: 1px solid #e5e7eb; border-radius: 10px; padding: 10px; margin-bottom: 10px; text-align: right; }
    .order h4 { margin: 0 0 6px; font-size: 15px; }
    .order ul { margin: 0 0 6px; padding-inline-start: 18px; }
    .order .meta { font-size: 13px; color: #374151; }

    .status { font-weight: bold; padding: 3px 8px; border-radius: 999px; display: inline-block; margin-top: 6px; font-size: 12px; }
    .red { background: crimson; color: #fff; }
    .yellow { background: goldenrod; color: #111; }
    .green { background: seagreen; color: #fff; }
    .blue { background: royalblue; color: #fff; }
    .gray { background: #9ca3af; color: #fff; }

    .unassigned { background: #fff7ed; border: 1px dashed #f59e0b; border-radius: 10px; padding: 10px; }
  </style>
</head>
<body>
  <h1>ğŸ“Š Ù„ÙˆØ­Ø© Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø¹Ù…Ø§Ù„</h1>
  <p class="hint">Ø§Ù„Ù…ØµØ¯Ø±: <b>Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ø¯Ø§Ø¦Ù…</b> (workersArchive). ÙŠØªÙ… Ù†Ø³Ø® Ø£ÙŠ Ø·Ù„Ø¨ ÙŠØµÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø³Ø§Ø± <code>orders/</code> ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù‡Ù†Ø§ØŒ ÙˆÙ„Ù† ÙŠØªØ£Ø«Ø± Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø±Ø¶ Ø¨Ø­Ø°Ù Ø§Ù„Ù…Ø¯ÙŠØ± Ø£Ùˆ Ø·Ù„Ø¨ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø²Ø±Ù‚.</p>

  <div class="wrap">
    <section class="panel">
      <h2>Ø·Ù„Ø¨Ø§Øª ØºÙŠØ± Ù…ÙØ³Ù†Ø¯Ø© Ø¨Ø¹Ø¯ (Ù„Ù„Ù…Ø¹Ù„ÙˆÙ…ÙŠØ© ÙÙ‚Ø·)</h2>
      <div id="unassigned" class="unassigned"></div>
    </section>

    <section class="panel">
      <h2>Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ø¯Ø§Ø¦Ù… Ø­Ø³Ø¨ Ø§Ù„Ø¹Ø§Ù…Ù„</h2>
      <div class="grid">
        <div class="barista"><h3 id="title1">ğŸ‘¤ Barista 1 (0)</h3><div id="barista1"></div></div>
        <div class="barista"><h3 id="title2">ğŸ‘¤ Barista 2 (0)</h3><div id="barista2"></div></div>
        <div class="barista"><h3 id="title3">ğŸ‘¤ Barista 3 (0)</h3><div id="barista3"></div></div>
        <div class="barista"><h3 id="title4">ğŸ‘¤ Barista 4 (0)</h3><div id="barista4"></div></div>
        <div class="barista"><h3 id="title5">ğŸ‘¤ Barista 5 (0)</h3><div id="barista5"></div></div>
      </div>
    </section>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
    import { getDatabase, ref, onValue, onChildAdded, onChildChanged, get, set, update } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-database.js";

    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase (Ù†ÙØ³ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹)
    const firebaseConfig = {
      apiKey: "AIzaSyAYYtMci_1laKbOxpVYaHsMx670WPhtNbk",
      authDomain: "my-restaurant-aba99.firebaseapp.com",
      projectId: "my-restaurant-aba99",
      storageBucket: "my-restaurant-aba99.appspot.com",
      messagingSenderId: "512969391867",
      appId: "1:512969391867:web:36a528665b3469871a3a5e",
      databaseURL: "https://my-restaurant-aba99-default-rtdb.firebaseio.com/"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    // Ù…Ø³Ø§Ø±Ø§Øª
    const ORDERS_ROOT = ref(db, "orders");
    const ARCHIVE_BY_TABLE   = (t)=> ref(db, `workersArchive/orders/table${t}`); // Ù„ÙƒÙ„ Ø·Ø§ÙˆÙ„Ø©
    const ARCHIVE_BY_BARISTA = (b,t,k)=> ref(db, `workersArchive/baristas/${b}/table${t}/${k}`); // Ù„ÙƒÙ„ Ø¹Ø§Ù…Ù„

    // ===============
    // 1) Ù†Ø³Ø® ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø£Ø±Ø´ÙŠÙ Ø¹Ù†Ø¯ Ø£ÙŠ Ø¥Ø¶Ø§ÙØ©/ØªØºÙŠÙŠØ± ÙÙŠ orders/**
    //    (Ø¨Ø¯ÙˆÙ† Ø£Ø²Ø±Ø§Ø±ØŒ ÙˆØ¨Ø¯ÙˆÙ† Ø£ÙŠ Ø­Ø°Ù Ù…Ù† Ø§Ù„Ø£Ø±Ø´ÙŠÙ)
    // ===============
    function mirrorOrderToArchive(tableNumber, key, data){
      if (!data || typeof data !== 'object') return;
      const assignedTo = data.assignedTo || 'unassigned';
      const payload = {
        ...data,
        table: data.table || String(tableNumber),
        assignedTo,
        archivedAt: Date.now()
      };
      // Ø­ÙØ¸ ØªØ­Øª Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ø­Ø³Ø¨ Ø§Ù„Ø·Ø§ÙˆÙ„Ø©
      set(ref(db, `workersArchive/orders/table${tableNumber}/${key}`), payload);
      // ÙˆØ­ÙØ¸ Ù†Ø³Ø®Ø© Ø£Ø®Ø±Ù‰ ØªØ­Øª Ø§Ù„Ø¹Ø§Ù…Ù„ (Ø¥Ù† ÙˆÙØ¬Ø¯)
      set(ref(db, `workersArchive/baristas/${assignedTo}/table${tableNumber}/${key}`), payload);
    }

    // Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø¹Ù„Ù‰ ÙƒÙ„ Ø§Ù„Ø·Ø§ÙˆÙ„Ø§Øª Ø¯Ø§Ø®Ù„ orders/**
    onValue(ORDERS_ROOT, async (snap)=>{
      // Ø¹Ù†Ø¯ Ø£ÙŠ ØªØºÙŠÙŠØ±ØŒ Ù†Ù‚Ø±Ø£ Ø§Ù„Ø·Ø§ÙˆÙ„Ø§Øª ÙˆÙ†Ù†Ø³Ø® Ø£ÙŠ Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©/Ù…Ø¹Ø¯Ù„Ø© Ù„Ù„Ø£Ø±Ø´ÙŠÙ
      if (!snap.exists()) return; // Ù„Ø§ Ù†Ø­Ø°Ù Ø´ÙŠØ¦Ù‹Ø§ Ù…Ù† Ø§Ù„Ø£Ø±Ø´ÙŠÙ
      const orders = snap.val();
      for (const tableKey in orders){
        if (!tableKey.startsWith('table')) continue;
        const tableNumber = tableKey.replace('table','');
        const tableNode = orders[tableKey];
        // Ù‚Ø¯ ÙŠÙˆØ¬Ø¯ Ø­Ù‚Ù„ status Ø¹Ø§Ù… Ù„Ù„Ø·Ø§ÙˆÙ„Ø©ØŒ Ù†ØªØ¬Ø§Ù‡Ù„Ù‡
        for (const k in tableNode){
          const entry = tableNode[k];
          if (entry && typeof entry === 'object' && Array.isArray(entry.order)){
            mirrorOrderToArchive(tableNumber, k, entry);
          }
        }
      }
    });

    // ÙƒØ°Ù„Ùƒ Ù†Ù„ØªÙ‚Ø· ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ø·ÙÙ„ Ù…Ø¨Ø§Ø´Ø±Ø© (Ø£Ø¯Ù‚ ÙˆØ£Ø®Ù)
    for (let i=1;i<=21;i++){
      const tRef = ref(db, `orders/table${i}`);
      onChildAdded(tRef, (child)=>{
        const v = child.val();
        if (v && typeof v === 'object' && Array.isArray(v.order)){
          mirrorOrderToArchive(i, child.key, v);
        }
      });
      onChildChanged(tRef, (child)=>{
        const v = child.val();
        if (v && typeof v === 'object' && Array.isArray(v.order)){
          mirrorOrderToArchive(i, child.key, v);
        }
      });
    }

    // ===============
    // 2) Ø§Ù„Ø¹Ø±Ø¶ Ù…Ù† Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ø¯Ø§Ø¦Ù… ÙÙ‚Ø· (Ù„Ù† ÙŠØªØ£Ø«Ø± Ø¨Ø­Ø°Ù Ø§Ù„Ù…Ø¯ÙŠØ±)
    // ===============
    const counters = { barista1:0, barista2:0, barista3:0, barista4:0, barista5:0 };

    function clearUI(){
      for (let i=1;i<=5;i++){
        document.getElementById('barista'+i).innerHTML = '';
        document.getElementById('title'+i).textContent = `ğŸ‘¤ Barista ${i} (0)`;
      }
      document.getElementById('unassigned').innerHTML = '<em>Ù„Ø§ ÙŠÙˆØ¬Ø¯</em>';
      counters.barista1=counters.barista2=counters.barista3=counters.barista4=counters.barista5=0;
    }

    function statusColor(status){
      switch(status){
        case 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°': return 'red';
        case 'Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ø¶ÙŠØ±': return 'yellow';
        case 'Ø·Ù„Ø¨ Ø­Ø³Ø§Ø¨':   return 'blue';
        case 'Ù…Ù†ØªÙ‡ÙŠ':       return 'green';
        default:            return 'gray';
      }
    }

    function renderOrder(container, data){
      const div = document.createElement('div');
      div.className = 'order';
      const items = Array.isArray(data.order) ? data.order.map(it=>`<li>${it.name} Ã— ${it.qty} = ${it.qty * it.price}Ø¬</li>`).join('') : '';
      div.innerHTML = `
        <h4>ğŸ½ï¸ Ø·Ø§ÙˆÙ„Ø© ${data.table || ''}</h4>
        <ul>${items}</ul>
        <div class="meta"><b>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</b> ${data.total || 0} Ø¬Ù†ÙŠÙ‡</div>
        ${data.notes ? `<div class="meta"><b>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</b> ${data.notes}</div>` : ''}
        <span class="status ${statusColor(data.status)}">${data.status || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>
      `;
      container.appendChild(div);
    }

    // Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø¹Ø§Ù…Ù„ Ù…Ù† Ø§Ù„Ø£Ø±Ø´ÙŠÙ
    function subscribeArchive(){
      // Ù†Ø¹ÙŠØ¯ Ø¨Ù†Ø§Ø¡ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙƒØ§Ù…Ù„Ø© Ø¹Ù†Ø¯ Ø£ÙŠ ØªØºÙŠÙŠØ± Ø¬Ø°Ø±ÙŠ
      onValue(ref(db, 'workersArchive/baristas'), (snap)=>{
        clearUI();
        if (!snap.exists()) return;
        const byBarista = snap.val();
        // Ø£ÙˆÙ„Ø§Ù‹ Ù‚Ø³Ù… ØºÙŠØ± Ø§Ù„Ù…ÙØ³Ù†Ø¯
        if (byBarista.unassigned){
          const unassignedBox = document.getElementById('unassigned');
          unassignedBox.innerHTML = '';
          const tables = byBarista.unassigned;
          for (const t in tables){
            const orders = tables[t];
            for (const k in orders){
              renderOrder(unassignedBox, orders[k]);
            }
          }
        }
        // Ø«Ù… Ø§Ù„Ø®Ù…Ø³Ø© Ø¹Ù…Ø§Ù„
        for (let i=1;i<=5;i++){
          const key = 'barista'+i;
          const col = document.getElementById(key);
          const title = document.getElementById('title'+i);
          if (!byBarista[key]){ title.textContent = `ğŸ‘¤ Barista ${i} (0)`; continue; }
          const tables = byBarista[key];
          let count = 0;
          for (const t in tables){
            const orders = tables[t];
            for (const k in orders){
              renderOrder(col, orders[k]);
              count++;
            }
          }
          counters[key] = count;
          title.textContent = `ğŸ‘¤ Barista ${i} (${count})`;
        }
      });
    }

    // Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª
    subscribeArchive();
  </script>
</body>
</html>
