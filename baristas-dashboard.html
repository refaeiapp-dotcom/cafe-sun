<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>لوحة متابعة العمال (أرشيف ثابت)</title>
  <style>
    body { font-family: Tahoma, Arial, sans-serif; margin:0; padding:20px; background:#f7fafc; color:#222; }
    h1 { text-align:center; margin:0 0 16px; }

    .wrap { max-width:1280px; margin:0 auto; }
    .grid { display:grid; grid-template-columns:repeat(5, 1fr); gap:12px; }
    .barista { background:#ffffff; border:1px solid #e5e7eb; border-radius:12px; padding:10px; }
    .barista h3 { margin:0 0 8px; font-size:16px; color:#0b3b60; }

    .order { background:#f3f4f6; border:1px solid #e5e7eb; border-radius:10px; padding:10px; margin-bottom:10px; text-align:right; }
    .order h4 { margin:0 0 6px; font-size:15px; }
    .order ul { margin:0 0 6px; padding-inline-start:18px; }
    .order .meta { font-size:13px; color:#374151; }

    .status { font-weight:bold; padding:3px 8px; border-radius:999px; display:inline-block; margin-top:6px; font-size:12px; }
    .red { background:crimson; color:#fff; }
    .yellow { background:goldenrod; color:#111; }
    .green { background:seagreen; color:#fff; }
    .blue { background:royalblue; color:#fff; }
    .gray { background:#9ca3af; color:#fff; }

    .actions { text-align:center; margin-top:18px; }
    .actions button {
      background:seagreen; color:#fff; border:none; padding:10px 18px;
      border-radius:8px; font-size:16px; cursor:pointer; margin:0 5px;
    }
    .actions button:hover { background:darkgreen; }
    .actions button.danger { background:crimson; }
    .actions button.danger:hover { background:darkred; }
  </style>
</head>
<body>
  <h1>📊 لوحة متابعة العمال</h1>

  <div class="wrap">
    <div class="grid">
      <div class="barista"><h3 id="title1">👤 Barista 1 (0)</h3><div id="barista1"></div></div>
      <div class="barista"><h3 id="title2">👤 Barista 2 (0)</h3><div id="barista2"></div></div>
      <div class="barista"><h3 id="title3">👤 Barista 3 (0)</h3><div id="barista3"></div></div>
      <div class="barista"><h3 id="title4">👤 Barista 4 (0)</h3><div id="barista4"></div></div>
      <div class="barista"><h3 id="title5">👤 Barista 5 (0)</h3><div id="barista5"></div></div>
    </div>

    <div class="actions">
      <button onclick="exportToExcel()">⬇️ تصدير إلى Excel</button>
      <button onclick="clearArchive()" class="danger">🗑️ تصفير الأرشيف</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
    import { getDatabase, ref, onValue, onChildAdded, onChildChanged, set } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-database.js";

    // إعدادات Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAYYtMci_1laKbOxpVYaHsMx670WPhtNbk",
      authDomain: "my-restaurant-aba99.firebaseapp.com",
      projectId: "my-restaurant-aba99",
      storageBucket: "my-restaurant-aba99.appspot.com",
      messagingSenderId: "512969391867",
      appId: "1:512969391867:web:36a528665b3469871a3a5e",
      databaseURL: "https://my-restaurant-aba99-default-rtdb.firebaseio.com/"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    // ————— mirroring: نسخ الطلبات تلقائيًا إلى الأرشيف الدائم —————
    const ORDERS_ROOT = ref(db, "orders");

    function mirrorOrderToArchive(tableNumber, key, data){
      if (!data || typeof data !== 'object') return;
      const assignedTo = data.assignedTo || 'unassigned';
      const payload = {
        ...data,
        table: data.table || String(tableNumber),
        assignedTo,
        archivedAt: Date.now()
      };
      set(ref(db, `workersArchive/orders/table${tableNumber}/${key}`), payload);
      set(ref(db, `workersArchive/baristas/${assignedTo}/table${tableNumber}/${key}`), payload);
    }

    onValue(ORDERS_ROOT, (snap)=>{
      if (!snap.exists()) return;
      const orders = snap.val();
      for (const tableKey in orders){
        if (!tableKey.startsWith('table')) continue;
        const tableNumber = tableKey.replace('table','');
        const tableNode = orders[tableKey];
        for (const k in tableNode){
          const entry = tableNode[k];
          if (entry && typeof entry === 'object' && Array.isArray(entry.order)){
            mirrorOrderToArchive(tableNumber, k, entry);
          }
        }
      }
    });

    for (let i=1;i<=21;i++){
      const tRef = ref(db, `orders/table${i}`);
      onChildAdded(tRef, (child)=>{
        const v = child.val();
        if (v && typeof v === 'object' && Array.isArray(v.order)){
          mirrorOrderToArchive(i, child.key, v);
        }
      });
      onChildChanged(tRef, (child)=>{
        const v = child.val();
        if (v && typeof v === 'object' && Array.isArray(v.order)){
          mirrorOrderToArchive(i, child.key, v);
        }
      });
    }

    // ————— العرض من workersArchive فقط —————
    const counters = { barista1:0, barista2:0, barista3:0, barista4:0, barista5:0 };
    let byBaristaCache = {}; // هنستخدمه للتصدير إلى Excel

    function clearUI(){
      for (let i=1;i<=5;i++){
        document.getElementById('barista'+i).innerHTML = '';
        document.getElementById('title'+i).textContent = `👤 Barista ${i} (0)`;
      }
      counters.barista1=counters.barista2=counters.barista3=counters.barista4=counters.barista5=0;
    }

    function statusColor(status){
      switch(status){
        case 'قيد التنفيذ': return 'red';
        case 'قيد التحضير': return 'yellow';
        case 'طلب حساب':   return 'blue';
        case 'منتهي':       return 'green';
        default:            return 'gray';
      }
    }

    function renderOrder(container, data){
      const div = document.createElement('div');
      div.className = 'order';
      const items = Array.isArray(data.order)
        ? data.order.map(it=>`<li>${it.name} × ${it.qty} = ${it.qty * it.price}ج</li>`).join('')
        : '';
      div.innerHTML = `
        <h4>🍽️ طاولة ${data.table || ''}</h4>
        <ul>${items}</ul>
        <div class="meta"><b>الإجمالي:</b> ${data.total || 0} جنيه</div>
        ${data.notes ? `<div class="meta"><b>ملاحظات:</b> ${data.notes}</div>` : ''}
        <span class="status ${statusColor(data.status)}">${data.status || 'غير محدد'}</span>
      `;
      container.appendChild(div);
    }

    function subscribeArchive(){
      onValue(ref(db, 'workersArchive/baristas'), (snap)=>{
        clearUI();
        if (!snap.exists()) { byBaristaCache = {}; return; }
        const byBarista = snap.val();
        byBaristaCache = byBarista; // نخزّن آخر نسخة للتصدير

        for (let i=1;i<=5;i++){
          const key = 'barista'+i;
          const col = document.getElementById(key);
          const title = document.getElementById('title'+i);
          if (!byBarista[key]){ title.textContent = `👤 Barista ${i} (0)`; continue; }

          const tables = byBarista[key];
          let count = 0;
          for (const t in tables){
            const orders = tables[t];
            for (const k in orders){
              renderOrder(col, orders[k]);
              count++;
            }
          }
          counters[key] = count;
          title.textContent = `👤 Barista ${i} (${count})`;
        }
      });
    }

    subscribeArchive();

    // ————— تصدير إلى Excel (xlsx فعلي) —————
    window.exportToExcel = async function(){
      const XLSX = await import('https://cdn.jsdelivr.net/npm/xlsx@0.18.5/+esm');

      const rows = [
        ["العامل","رقم الطاولة","الطلبات","الإجمالي","الحالة","ملاحظات","وقت الأرشفة"]
      ];

      for (let i=1;i<=5;i++){
        const key = 'barista'+i;
        const workerName = `Barista ${i}`;
        if (!byBaristaCache[key]) continue;

        const tables = byBaristaCache[key];
        for (const t in tables){
          const orders = tables[t];
          for (const k in orders){
            const o = orders[k] || {};
            const items = Array.isArray(o.order)
              ? o.order.map(it=>`${it.name} × ${it.qty} = ${it.qty * it.price}ج`).join(" | ")
              : "";
            rows.push([
              workerName,
              o.table || t.replace('table',''),
              items,
              o.total ?? "",
              o.status ?? "",
              o.notes ?? "",
              o.archivedAt ? new Date(o.archivedAt).toLocaleString('ar-EG') : ""
            ]);
          }
        }
      }

      if (rows.length === 1) rows.push(["","","","","","",""]);

      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(rows);
      XLSX.utils.book_append_sheet(wb, ws, "Workers_Archive");
      const out = XLSX.write(wb, { bookType: "xlsx", type: "array" });

      const blob = new Blob([out], {type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "workers_orders.xlsx";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    };

    // ————— تصفير الأرشيف —————
    window.clearArchive = async function(){
      if (!confirm("⚠️ هل أنت متأكد أنك تريد مسح الأرشيف بالكامل؟")) return;
      try {
        await set(ref(db, 'workersArchive'), null);
        alert("✅ تم مسح الأرشيف بالكامل بنجاح");
      } catch(err){
        console.error(err);
        alert("❌ حدث خطأ أثناء المسح");
      }
    };
  </script>
</body>
</html>
